<!doctype html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>multi firebase</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script src="https://skyway.io/dist/0.3/peer.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/3.6.0/firebase.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script>
            function _assert(desc, v) {
                if (v) {
                    return;
                } else {
                    let caller = _assert.caller || 'Top level';
                    console.error('ASSERT in %s, %s is :', caller, desc, v);
                }
            }
        </script>
    </head>
    <body>
        <div>
            <button type="button" onclick="startVideo();">Start Video</button>
            <button type="button" onclick="stopVideo();">Stop Video</button>
            &nbsp;
            <button type="button" onclick="connect();">Connect</button>
            <button type="button" onclick="hangUp();">Hang Up</button>
            &nbsp;
            <a id="room_link" href="" target="_blank">Open another window (link to this room)</a>
            <a id="mail_link" href="" target="_blank">Mail link of this room</a>
        </div>
        <div>
            <div>
                <video id="local_video" autoplay></video>
            </div>
            <h1>
                <small>My ID:</small>
                <span id="myId"></span>
            </h1>
            <div class="connects">
                <input id="connect"></input>
                <span id="connectButton" class="btn btn-primary">Connect</span>
            </div>
            <div class="connected"></div>
            <div class="messages">
                <input id="message"></input>
                <span id="sendMessage" class="btn btn-primary">Send</span>
                <div id="messageData"></div>
            </div>

        </div>
        <div id="container"></div>
        <div id="text_content"></div>
        <div id="buttons" class="text-center">
            <button id="startRecBtn">認識開始</button>
            <button id="stopRecBtn">認識終了</button>
        </div>
    </body>
    <script src="webrtc.js"></script>
    <script>
        //  音声認識モジュール
        $(document).ready(function () {
            // 音声処理モジュール
            var PEERJS_ID = '6f0d6813-40ff-4369-abe7-95c5983b8d67';
            var myId = String(Math.ceil(Math.random() * 1000 + 100));
            var peer = new Peer(myId, {key: PEERJS_ID});

            $('#myId').text(myId);
            var inputMessage = function (id, message) {
                $('#messageData').prepend($('<div/>').text(id + ': ' + message));
            };

            var connect = function (conn) {
                $('.connected').prepend($('<div/>').text('ID: ' + conn.peer + 'と通信中'));

                $('#sendMessage').click(function () {
                    var text = $('#message').val();
                    $('#message').val('');
                    if (text === '')
                        return;
                    $.each(peer.connections, function (_id, _conn) {
                        console.log("id:" + _id + "conn:" + _conn[0]);
                        _conn[0].send({message: text, ids: [myId]});
                    });
                    inputMessage(myId, text);
                });

                conn.on('data', function (data) {
                    console.log("取得したデータ：" + data);
                    var id = data.ids[0];
                    var ids = data.ids;
                    var message = data.message;
                    $.each(peer.connections, function (_id, _conn) {
                        if ($.inArray(_id, ids) == -1) {
                            ids.push(myId);
                            _conn[0].send({message: message, ids: ids});
                        }
                    });
                    inputMessage(id, message);

                });
            };

            $('#connectButton').click(function () {
                var id = $('#connect').val();
                if (id === '')
                    return;
                var connectFlag = false;
                $.each(peer.connections, function (_id) {
                    if (id == _id)
                        connectFlag = true;
                    }
                );
                if (connectFlag)
                    return;
                var conn = peer.connect(id, {'serialization': 'binary-utf8'});
                conn.on('open', function () {
                    connect(conn);
                });
            });

            peer.on('connection', function (conn) {
                connect(conn);
            });
            var userSaid = function (str, s) {
                return str.indexOf(s) > -1;
            }

            var rec = new webkitSpeechRecognition();
            rec.continuous = false;
            rec.interimResults = false;
            rec.lang = 'ja-JP';

            function SayName(str) {
                var names = getName();
                var sayname;
                for (var i = 0; i < names.length; i++) {
                    if (str.indexOf(names[i]) > -1) {
                        sayname = names[i];
                    }
                }
                return sayname;
            }

            // recognition.onspeechstart = function () {     var myRemoteID = getMyRemoteVideoid();     console.log('Speech has been detected');     $.each(peer.connections, function (_id, _conn) {         _conn[0].send({message: 'start', id: myRemoteID}); }); }
            // rec.onspeechend = function () {     console.log('Speech has stopped being detected');     $.each(peer.connections, function (_id, _conn) {         _conn[0].send({message: 'stop', id: myRemoteID});     }); }
            rec.onresult = function (e) {
                for (var i = e.resultIndex; i < e.results.length; ++i) {
                    if (e.results[i].isFinal) {
                        var str = e.results[i][0].transcript;
                        document.querySelector('#text_content').textContent = str;
                        console.log('Recognised: ' + str);
                        console.log(getName());
                        var sayname = SayName(str);
                        console.log(sayname);
                        if (userSaid(str, sayname)) {
                            var e = NamedElement[sayname];
                            switchbyname(e);
                            console.log(e);
                        }
                    }
                }
            }
            $("#startRecBtn").click(function () {
                rec.start();
            });
            $("#stopRecBtn").click(function () {
                rec.stop();
            });
        });

        // VideoElementと名前をオブジェクトとして管理
        var NamedElement = new Array();
        var username;
        document.addEventListener("dblclick", function (e) {
            var elem = e.target;
            if (elem.tagName.toLowerCase() === "video") {
                username = window.prompt("名前を入力してください");
            }
            setName(username, elem);
            console.log(NamedElement);
        }, true);

        function switchbyname(e) {
            $(e).css("width", "600px");
            $(e).css("height", "450px");
        }
        function getName() {
            var names = [];
            for (var name in NamedElement) {
                names.push(name);
            }
            return names;
        }

        function setName(name, element) {
            if (name === "" || name === null) {
                return
            } else {
                NamedElement[name] = element;
            }
        }
    </script>
</html>
